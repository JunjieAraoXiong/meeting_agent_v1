<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting Agent - Feishu Text-Only</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Utilities
        function pad2(n) { return n < 10 ? `0${n}` : String(n); }
        
        function fmtTime(s) {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = Math.floor(s % 60);
            return h > 0 ? `${h}:${pad2(m)}:${pad2(sec)}` : `${m}:${pad2(sec)}`;
        }

        function parseTimeToSeconds(str) {
            const parts = str.split(':');
            const minutes = parseInt(parts[0], 10);
            const seconds = parseInt(parts[1], 10);
            return minutes * 60 + seconds;
        }

        function parseTranscript(raw) {
            const lines = raw.split(/\r?\n/).map((l) => l.trim());
            const segs = [];
            const feishuSpeakerPattern = /^(.+?)\s+(\d{1,2}:\d{2})$/;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (!line) continue;

                const feishuMatch = line.match(feishuSpeakerPattern);
                if (feishuMatch) {
                    const speaker = feishuMatch[1].trim();
                    const timestampStr = feishuMatch[2];
                    const t = parseTimeToSeconds(timestampStr);
                    
                    let text = "";
                    let j = i + 1;
                    while (j < lines.length && lines[j] && !lines[j].match(feishuSpeakerPattern)) {
                        if (text) text += " ";
                        text += lines[j].trim();
                        j++;
                    }
                    
                    if (text) {
                        segs.push({ idx: segs.length, t, speaker, text });
                    }
                    i = j - 1;
                }
            }

            // Ensure strictly increasing time
            for (let i = 1; i < segs.length; i++) {
                if (segs[i].t <= segs[i - 1].t) segs[i].t = segs[i - 1].t + 1;
            }
            return segs;
        }

        function extractTerms(segments) {
            const map = new Map();
            
            const addOcc = (term, idx, context) => {
                const key = term.trim();
                if (!key) return;
                const curr = map.get(key);
                if (curr) {
                    curr.count += 1;
                    curr.occurrences.push(idx);
                } else {
                    map.set(key, { term: key, count: 1, firstIdx: idx, occurrences: [idx], contexts: [context] });
                }
            };

            const techNumberRe = /(\d+\.?\d*[BM]?)\s*(æ¨¡å‹|å‚æ•°|ç‰ˆæœ¬)/g;
            const chineseCompoundRe = /([\u4e00-\u9fa5]{2,4})(é¡¹ç›®|æ¨¡å‹|æ¨¡å¼|ç³»ç»Ÿ|å¹³å°|ç®—æ³•|æ–¹æ¡ˆ|äº§å“|è®¾å¤‡|çœ¼é•œ|æ‰‹ç¯|å½•éŸ³)/g;
            const brandRe = /\b(Meta|Google|è°·æ­Œ|è‹¹æœ|å°ç±³|é›·æœ‹|Buzz|Take\s+Note|OA)\b/gi;

            segments.forEach((seg) => {
                const { text, idx } = seg;
                let m;
                while ((m = techNumberRe.exec(text))) addOcc(m[0], idx, text);
                while ((m = chineseCompoundRe.exec(text))) addOcc(m[0], idx, text);
                while ((m = brandRe.exec(text))) addOcc(m[0], idx, text);

                const cjkRe = /([\u4e00-\u9fa5]{2,6})/g;
                const seen = new Set();
                while ((m = cjkRe.exec(text))) {
                    const term = m[1];
                    if (seen.has(term)) continue;
                    seen.add(term);
                    if (!/^(è¿™ä¸ª|é‚£ä¸ª|å°±æ˜¯|ç„¶å|ä½†æ˜¯|å¦‚æœ|æ‰€ä»¥|å› ä¸º|å¯èƒ½|åº”è¯¥|éœ€è¦|è§‰å¾—|çŸ¥é“|çœ‹åˆ°|å¬åˆ°|è¯´çš„|åšçš„|ç”¨çš„|æœ‰çš„|æ²¡æœ‰|ä¸æ˜¯|æ˜¯çš„|å¯¹çš„|å¥½çš„|è¡Œçš„)$/i.test(term)) {
                        addOcc(term, idx, text);
                    }
                }
            });

            for (const [k, v] of Array.from(map.entries())) {
                const looksImportant = 
                    /\d+\.?\d*[BM]/.test(k) ||
                    /(é¡¹ç›®|æ¨¡å‹|æ¨¡å¼|ç³»ç»Ÿ|å¹³å°|ç®—æ³•|æ–¹æ¡ˆ|äº§å“|è®¾å¤‡|çœ¼é•œ|æ‰‹ç¯|å½•éŸ³)$/.test(k) ||
                    /^(Meta|Google|è°·æ­Œ|è‹¹æœ|å°ç±³|é›·æœ‹|Buzz|Take|Note|OA)$/i.test(k);
                if (v.count < 2 && !looksImportant) map.delete(k);
            }
            return map;
        }

        function escapeHtml(s) {
            return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        function highlightTerms(text, terms, active) {
            if (!text || !terms || terms.length === 0) return escapeHtml(text);
            
            const sorted = [...new Set(terms)].sort((a, b) => b.length - a.length);
            const pattern = new RegExp(`(${sorted.map(t => t.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")).join("|")})`, "gi");
            const lowerSet = new Set(sorted.map(t => t.toLowerCase()));
            const activeLower = active ? active.toLowerCase() : null;

            const parts = text.split(pattern);
            return parts.map((part) => {
                if (lowerSet.has(part.toLowerCase())) {
                    const isActive = activeLower && part.toLowerCase() === activeLower;
                    const cls = isActive ? "bg-yellow-300" : "bg-yellow-100";
                    return `<mark class="px-1 rounded cursor-pointer ${cls}" onclick="setActiveTerm('${part}')">${escapeHtml(part)}</mark>`;
                }
                return escapeHtml(part);
            }).join("");
        }

        const SAMPLE = \`æ±¤æ¬£é’° 00:00
çŒ«æˆ´åœ¨èº«ä¸Šï¼Œç„¶ååˆæœ‰å®šä½ï¼Œåˆæœ‰ç³–åŒ…ä¸ç¿»è¯‘ã€‚å—¯ï¼Œå»å¹´å¥½åƒå°±æœ‰è¿™ä¸ªï¼Œå¥½åƒå°±æœ‰ä¸€ä¸ªï¼Œå»å¹´å¥½åƒæœ‰ä¸€ä¸ªç±»ä¼¼çš„ï¼Œå°±æ˜¯ä¹Ÿæˆ´åœ¨ä»€ä¹ˆèº«ä¸Šå•Šï¼Ÿç‹—å•Šï¼Ÿå¯¹å•Šï¼Œé‚£ä¸ªç½‘ç«™çš„å“ªé‡Œå•Šï¼Ÿé‚£ä¸ªæœ‰æ²¡æœ‰æ€»çš„é‚£ä¸ª listï¼Ÿå¦‚æœå•ç‹¬å‘ä¸€ä¸ªï¼ŒOKï¼Œæˆ‘æ¥å‘ä¸€ä¸ªè¿™ç§çš„ listï¼Œå…ˆï¼Œè¿™ä¸ªå…ˆåˆ°ï¼Œæˆ‘å‘ä¹Ÿè¡Œï¼Œå¼ è€å¸ˆä¸ç”¨å‘ã€‚

æ±¤æ¬£é’° 00:56
ç„¶åï¼Œå—¯ï¼Œè¦ä¸ç„¶æˆ‘ä»¬å…ˆè¯´ï¼Œå—¯ï¼Œå°±æ˜å¤©ï¼Œä¸æ˜¯è¿˜æ˜¯ä¸‹åˆæœ‰é‚£ä¸ªå‘¨ä¼šå˜›ï¼Ÿå—¯ï¼Œå¯¹ï¼Œå°±å¤§å®¶æœ€è¿‘æœ‰æ²¡æœ‰ä»€ä¹ˆå›°éš¾ï¼Ÿç„¶åä»¥åŠæœ‰æ²¡æœ‰è¯†åˆ«åˆ°ä»€ä¹ˆæœºä¼šã€æƒ³æ³•çš„ï¼Ÿç„¶åå…¶ä»–çš„å°±æ˜¯ä¾‹è¡Œçš„ï¼Œæ¯”å¦‚åœ¨ä¼šä¸Šå°±ä¾‹è¡ŒåŒæ­¥äº†ã€‚ä¸»è¦æ˜¯æˆ‘è§‰å¾—å¤§ä¼šå‰æ²¡æœ‰ä»€ä¹ˆè¦å†³ç­–çš„ã€‚å¯¹ï¼Œä¸€ä¸ªæ˜¯é‚£ä¸ªæˆ‘çŸ¥é“çš„ï¼Œä¸€ä¸ªæ˜¯å¿—æ—­é‚£è¾¹ï¼Œå¯¹å§ï¼Ÿä»–æ‰‹æœºæµ‹è¿™ä¸ªå¼€å‘çš„èµ„æºï¼Œæˆ–è€…è¯´è¿™ç§èƒ½åŠ›æˆ‘ä»¬è¿˜æ¯”è¾ƒçŸ­ç¼ºä¸€äº›ï¼Œæ˜¯å§ï¼Ÿè¡Œï¼Œè¿™ä¸ªæ˜¯å·²ç»çŸ¥é“äº†ã€‚

æ±¤æ¬£é’° 01:36
å¯¹ï¼Œæˆ‘çœ‹è¿™ä¸ªé»‘é©¬é¡¹ç›®ä»–ä»¬éƒ½æœ‰åœ¨å…¨æ· OA ä¸Šéƒ¨ç½²ä¸€äº› 1.5B çš„ç«¯è§‚æµ‹æ¨¡å‹ã€‚å—¯ï¼Œå®Œå…¨æ˜¯æ¯”æˆ‘ä»¬è¿™ä¸ªå‚æ•°é‡è¦å¤§å¾—å¤šï¼Œç„¶åå¥½åƒè¿˜è¡Œï¼Œé‚£å¯ä»¥è”ç³»ä¸‹ä»–ä»¬ï¼Œæ˜¯å§ï¼Ÿåæ­£å°±æ˜¯é‚£ä¸ªé»‘é©¬ï¼Œè¿™ä¸ªé©¬æ‹‰æ¾ä¸Šï¼Œå¯¹ï¼Œæˆ‘è§‰å¾—å¯èƒ½é‚£äº›äººä¹Ÿå¾ˆé‡è¦ï¼Œçœ‹å“ªäº›äººæœ‰æ„æ€ï¼Œç„¶åè·Ÿä»–ä»¬èŠä¸€èŠã€‚

æ±¤æ¬£é’° 02:04
ä½ è¿™ä¸ªçŸ¥é“ï¼Œç„¶åæˆ‘å†é—®ä¸€ä¸‹è¿™è¾¹çš„ Buzzï¼Œæ˜¯å§ï¼Ÿç„¶åæˆ‘ä¹Ÿç•™äº†ã€‚é‚£ä¸ªè¿˜æœ‰æ²¡æœ‰ä»€ä¹ˆå›°éš¾å•Šï¼Ÿæœ‰æ²¡æœ‰å¤§å®¶è§‰å¾—é‡åˆ°ä¸€äº›å›°éš¾çš„ï¼Ÿå¯¹ã€‚å—¯ï¼Œæœ‰ä¸ªæ¯”è¾ƒå¤§çš„å›°éš¾ï¼Œå°±è·Ÿä¸Šå¤´èŠçš„é‚£ä¸ªéšç§æ¨¡å¼ï¼Œå…¶å®æ„Ÿè§‰æ²¡æœ‰ç‰¹åˆ«å¥½çš„æ€è·¯ã€‚å—¯ï¼Œä½†æ˜¯æˆ‘åˆå›å½’åˆ°é‚£ä¸ªçœ¼é•œé—®é¢˜ï¼Œå› ä¸ºä¹‹å‰è°·æ­Œä»–ä»¬ä¸æ˜¯ä¹Ÿé‡åˆ°å¾ˆéš¾è§£é‡Šçš„é—®é¢˜å˜›ï¼Ÿå—¯ï¼Œç„¶åå›é¡¾äº†ä¸€ä¸‹é›·æœ‹çš„è§£æ³•ï¼Œé‚£ä¸ª Meta çš„è§£æ³•ï¼Œä½†æ˜¯åˆ°å’±ä»¬è¿™å—ï¼Œè¯­éŸ³ç›¸å…³çš„é‚£ä¸ªäººè¿˜æ²¡æœ‰ç‰¹åˆ«å¥½çš„ä¸€ä¸ªã€‚è¡Œï¼Œè¿™ä¸ªå¾…ä¼šæˆ‘ä»¬å†è¯´ã€‚è¡Œï¼Œè¿™ä¸ªåŒå­¦å¤§æ¦‚çŸ¥é“äº†ã€‚\`;

        // Global function for onclick
        window.setActiveTerm = (term) => {
            window.currentActiveTerm = term;
            document.querySelector('#active-term').textContent = term;
            document.querySelector('#term-definition').textContent = \`å®šä¹‰: \${term} - è¿™æ˜¯ä¸€ä¸ªåœ¨ä¼šè®®ä¸­æåˆ°çš„é‡è¦æœ¯è¯­ã€‚\`;
        };

        function MeetingAgent() {
            const [raw, setRaw] = useState(SAMPLE.trim());
            const [segments, setSegments] = useState(() => parseTranscript(SAMPLE));
            const [play, setPlay] = useState(false);
            const [playhead, setPlayhead] = useState(0);
            const [activeIdx, setActiveIdx] = useState(-1);
            const [showPaste, setShowPaste] = useState(false);
            const [pasteDraft, setPasteDraft] = useState("");

            const maxT = segments.length ? segments[segments.length - 1].t + 20 : 0;
            const termMap = useMemo(() => extractTerms(segments), [segments]);

            const introducedTerms = useMemo(() => {
                const set = new Set();
                for (const [term, info] of termMap.entries()) {
                    if (info.firstIdx <= activeIdx) set.add(term);
                }
                const arr = Array.from(set);
                return arr.length > 0 ? arr : Array.from(termMap.keys());
            }, [termMap, activeIdx]);

            useEffect(() => {
                if (!play) return;
                const id = setInterval(() => {
                    setPlayhead((t) => Math.min(t + 1, maxT));
                }, 1000);
                return () => clearInterval(id);
            }, [play, maxT]);

            useEffect(() => {
                let idx = -1;
                for (let i = 0; i < segments.length; i++) {
                    if (segments[i].t <= playhead) idx = i; else break;
                }
                setActiveIdx(idx);
            }, [playhead, segments]);

            useEffect(() => {
                const segs = parseTranscript(raw);
                setSegments(segs);
                setPlayhead(0);
                setActiveIdx(-1);
            }, [raw]);

            function renderSegment(seg) {
                const html = highlightTerms(seg.text, introducedTerms, window.currentActiveTerm);
                const isRevealed = seg.idx <= activeIdx;
                return (
                    <div key={seg.idx} className={\`rounded-xl px-3 py-2 my-1 border \${isRevealed ? "bg-white" : "bg-gray-50 opacity-60"}\`}>
                        <div className="text-xs text-gray-500 flex items-center gap-2">
                            <span className="font-mono">{fmtTime(seg.t)}</span>
                            {seg.speaker && <span className="px-2 py-0.5 bg-gray-100 rounded-full">{seg.speaker}</span>}
                        </div>
                        <div className="mt-1 leading-relaxed" dangerouslySetInnerHTML={{ __html: html }} />
                    </div>
                );
            }

            return (
                <div className="w-full min-h-screen bg-neutral-50 p-4">
                    <div className="max-w-7xl mx-auto mb-4">
                        <h1 className="text-2xl font-semibold mb-4">ğŸ¯ Feishu Meeting Agent - Local Demo</h1>
                        <div className="flex items-center gap-2 mb-3">
                            <button 
                                className="text-sm px-3 py-2 bg-amber-50 border rounded-xl hover:shadow"
                                onClick={() => { setPasteDraft(""); setShowPaste(true); }}
                            >
                                ğŸ“‹ Paste Transcript
                            </button>
                            <button 
                                className="text-sm px-3 py-2 bg-white border rounded-xl hover:shadow"
                                onClick={() => setRaw(SAMPLE.trim())}
                            >
                                ğŸ”„ Load Sample
                            </button>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <div className="lg:col-span-2">
                            <div className="bg-white rounded-2xl shadow-sm border p-3">
                                <div className="flex items-center justify-between mb-2">
                                    <span className="text-sm font-medium">â±ï¸ Simulated Timeline</span>
                                    <div className="flex items-center gap-2">
                                        <button
                                            className={\`px-3 py-1.5 rounded-xl text-sm border \${play ? "bg-red-50" : "bg-green-50"}\`}
                                            onClick={() => setPlay(p => !p)}
                                        >
                                            {play ? "â¸ï¸ Pause" : "â–¶ï¸ Play"}
                                        </button>
                                        <button 
                                            className="px-3 py-1.5 rounded-xl text-sm border"
                                            onClick={() => { setPlay(false); setPlayhead(0); }}
                                        >
                                            ğŸ”„ Reset
                                        </button>
                                    </div>
                                </div>

                                <div className="flex items-center gap-3">
                                    <span className="text-xs font-mono text-gray-500 w-12">{fmtTime(playhead)}</span>
                                    <input 
                                        type="range" 
                                        min={0} 
                                        max={Math.max(maxT, 1)} 
                                        value={playhead} 
                                        onChange={(e) => setPlayhead(parseInt(e.target.value, 10))}
                                        className="w-full"
                                    />
                                    <span className="text-xs font-mono text-gray-500 w-12 text-right">{fmtTime(maxT)}</span>
                                </div>

                                <div className="mt-3 h-[72vh] overflow-auto pr-1 custom-scrollbar">
                                    {segments.map(seg => renderSegment(seg))}
                                </div>
                            </div>
                        </div>

                        <div className="lg:col-span-1">
                            <div className="bg-white rounded-2xl shadow-sm border p-3">
                                <div className="text-sm font-medium mb-3">ğŸ“– Smart Definitions</div>
                                <div id="active-term" className="text-sm font-semibold text-blue-600 mb-2">ç‚¹å‡»å·¦ä¾§é«˜äº®æœ¯è¯­æŸ¥çœ‹å®šä¹‰</div>
                                <div id="term-definition" className="text-sm text-gray-600 mb-4">é€‰æ‹©ä¸€ä¸ªæœ¯è¯­ä»¥æŸ¥çœ‹å…¶å®šä¹‰å’Œä¸Šä¸‹æ–‡ã€‚</div>
                                
                                <div className="text-xs text-gray-500 mb-2">Detected Terms:</div>
                                <div className="flex flex-wrap gap-1">
                                    {Array.from(termMap.keys()).slice(0, 10).map(term => (
                                        <button 
                                            key={term}
                                            className="text-xs px-2 py-1 border rounded-full hover:bg-gray-50"
                                            onClick={() => window.setActiveTerm(term)}
                                        >
                                            {term}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>

                    {showPaste && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center">
                            <div className="absolute inset-0 bg-black/40" onClick={() => setShowPaste(false)} />
                            <div className="relative z-10 w-full max-w-2xl bg-white border rounded-2xl shadow-lg p-4">
                                <div className="flex items-center justify-between mb-2">
                                    <div className="text-sm font-medium">ğŸ“‹ Paste Transcript</div>
                                    <button 
                                        className="text-xs px-2 py-1 border rounded-lg hover:bg-gray-50"
                                        onClick={() => setShowPaste(false)}
                                    >
                                        âœ• Close
                                    </button>
                                </div>
                                <textarea 
                                    className="w-full h-60 border rounded-xl p-3 font-mono text-xs bg-neutral-50"
                                    placeholder={\`åœ¨æ­¤ç²˜è´´ Feishu è½¬å½•æ–‡æœ¬...

æ ¼å¼:
æ±¤æ¬£é’° 00:00
æ–‡æœ¬å†…å®¹...

è¯´è¯äºº 1 01:30
æ›´å¤šå†…å®¹...\`}
                                    value={pasteDraft}
                                    onChange={(e) => setPasteDraft(e.target.value)}
                                />
                                <div className="mt-3 flex items-center justify-end gap-2">
                                    <button 
                                        className="text-sm px-3 py-2 bg-white border rounded-xl hover:shadow"
                                        onClick={() => setShowPaste(false)}
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        className="text-sm px-3 py-2 bg-amber-50 border rounded-xl hover:shadow"
                                        onClick={() => { 
                                            if (pasteDraft.trim().length) setRaw(pasteDraft.trim()); 
                                            setShowPaste(false); 
                                        }}
                                    >
                                        âœ… Load Transcript
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<MeetingAgent />, document.getElementById('root'));
    </script>
</body>
</html>

